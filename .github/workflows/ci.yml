name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  validate:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: true
        fetch-depth: 1

    - name: Configure git for sparse checkout
      run: |
        cd .orca-slicer
        git sparse-checkout set resources/profiles
        cd ..

    - name: Cache APT packages
      uses: awalsh128/cache-apt-pkgs-action@latest
      with:
        packages: openscad xvfb gstreamer1.0-plugins-base libwebkit2gtk-4.1-0 libwebkitgtk-6.0-4 libjavascriptcoregtk-6.0-1
        version: 1.1

    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        version: "latest"
        enable-cache: true

    - name: Install OrcaSlicer
      run: |
        wget -q "https://github.com/OrcaSlicer/OrcaSlicer/releases/download/v2.3.1/OrcaSlicer_Linux_AppImage_Ubuntu2404_V2.3.1.AppImage" -O OrcaSlicer.AppImage
        chmod +x OrcaSlicer.AppImage
        ./OrcaSlicer.AppImage --appimage-extract >/dev/null 2>&1
        sudo rm -rf /opt/orcaslicer
        sudo mv squashfs-root /opt/orcaslicer
        sudo ln -sf /opt/orcaslicer/AppRun /usr/local/bin/orca-slicer

    - name: Sync Python dependencies
      run: uv sync

    - name: Lint OpenSCAD files
      run: uv run scad-tools lint

    - name: Run OpenSCAD unit tests
      run: uv run scad-tools test

    - name: Validate models render
      run: uv run scad-tools check

    - name: Render models
      env:
        GITHUB_REPOSITORY: ${{ github.repository }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_REF_NAME: ${{ github.ref_name }}
      run: uv run scad-tools render

    - name: Slice models
      env:
        GITHUB_REPOSITORY: ${{ github.repository }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_REF_NAME: ${{ github.ref_name }}
      run: uv run scad-tools slice

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: build-artifacts
        path: |
          artifacts/stl/*.stl
          artifacts/preview/*.png
          artifacts/gcode/*.3mf
          artifacts/logs/*.log
        retention-days: 7
