name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  validate:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: true
        fetch-depth: 1

    - name: Configure git for sparse checkout
      run: |
        cd .orca-slicer
        git sparse-checkout set resources/profiles
        cd ..

    - name: Cache APT packages
      uses: awalsh128/cache-apt-pkgs-action@latest
      with:
        packages: openscad xvfb gstreamer1.0-plugins-base libwebkit2gtk-4.1-0
        version: 1.0

    - name: Cache just binary
      id: cache-just
      uses: actions/cache@v4
      with:
        path: /usr/local/bin/just
        key: just-1.36.0-linux-x86_64

    - name: Install just
      if: steps.cache-just.outputs.cache-hit != 'true'
      run: |
        wget -qO- https://github.com/casey/just/releases/download/1.36.0/just-1.36.0-x86_64-unknown-linux-musl.tar.gz | \
        sudo tar xzf - -C /usr/local/bin just

    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        version: "latest"

    - name: Cache uv dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/uv
        key: uv-${{ runner.os }}-${{ hashFiles('uv.lock') }}
        restore-keys: |
          uv-${{ runner.os }}-

    - name: Cache OrcaSlicer
      id: cache-orca
      uses: actions/cache@v4
      with:
        path: /opt/orcaslicer
        key: orcaslicer-2.3.1-ubuntu2404

    - name: Install OrcaSlicer
      if: steps.cache-orca.outputs.cache-hit != 'true'
      run: |
        ORCA_VERSION="2.3.1"
        wget "https://github.com/OrcaSlicer/OrcaSlicer/releases/download/v${ORCA_VERSION}/OrcaSlicer_Linux_AppImage_Ubuntu2404_V${ORCA_VERSION}.AppImage" -O OrcaSlicer.AppImage
        chmod +x OrcaSlicer.AppImage
        ./OrcaSlicer.AppImage --appimage-extract >/dev/null 2>&1
        sudo mv squashfs-root /opt/orcaslicer

    - name: Create OrcaSlicer symlink
      run: sudo ln -sf /opt/orcaslicer/AppRun /usr/local/bin/orca-slicer

    - name: Cache ORAS CLI
      id: cache-oras
      uses: actions/cache@v4
      with:
        path: /usr/local/bin/oras
        key: oras-1.2.2-linux-amd64

    - name: Install ORAS CLI
      if: steps.cache-oras.outputs.cache-hit != 'true'
      run: |
        curl -sLO https://github.com/oras-project/oras/releases/download/v1.2.2/oras_1.2.2_linux_amd64.tar.gz
        tar -xzf oras_1.2.2_linux_amd64.tar.gz oras
        sudo mv oras /usr/local/bin/

    - name: Login to GHCR
      run: echo "${{ secrets.GITHUB_TOKEN }}" | oras login ghcr.io -u ${{ github.actor }} --password-stdin

    - name: Update justfile for Linux paths
      run: |
        # Replace brew backtick expression (evaluated at parse time, fails on Linux)
        sed -i 's|_openscad_app := .*|_openscad_app := ""|' justfile
        # Update OpenSCAD binary path
        sed -i 's|_openscad_bin := .*|_openscad_bin := "openscad"|' justfile
        # Update OrcaSlicer binary path
        sed -i 's|_orca_slicer_bin := .*|_orca_slicer_bin := "orca-slicer"|' justfile

    - name: Verify tools
      run: |
        just --version
        openscad --version
        xvfb-run orca-slicer --help | head -5
        oras version

    - name: Sync Python dependencies
      run: uv sync

    - name: Lint OpenSCAD files
      run: uv run python -m scripts.customizer_lint projects/

    - name: Validate models render
      run: xvfb-run just check

    - name: Render models (with GHCR caching)
      env:
        GITHUB_REPOSITORY: ${{ github.repository }}
      run: |
        chmod +x scripts/cached_render.sh
        find projects -name "*.scad" -type f | while read -r f; do
          scripts/cached_render.sh "$f" artifacts
        done

    - name: Slice models (with GHCR caching)
      env:
        GITHUB_REPOSITORY: ${{ github.repository }}
      run: |
        chmod +x scripts/cached_slice.sh
        find projects -name "*.scad" -type f | while read -r model; do
          project_name=$(dirname "$model" | sed 's|projects/||')
          basename=$(basename "$model" .scad)
          fullname="${project_name}__${basename}"
          scripts/cached_slice.sh "$fullname" artifacts
        done

    - name: Upload STL models
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: stl-models
        path: artifacts/stl/*.stl
        retention-days: 7

    - name: Upload preview images
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: preview-images
        path: artifacts/preview/*.png
        retention-days: 7

    - name: Upload sliced 3MF files
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: sliced-3mf
        path: artifacts/gcode/*.3mf
        retention-days: 7

    - name: Upload logs
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: build-logs
        path: artifacts/logs/*.log
        retention-days: 7

    - name: Check for errors
      run: |
        if grep -r "error when validate" artifacts/logs/ 2>/dev/null; then
          echo "❌ Found validation errors in slicing logs"
          exit 1
        fi
        echo "✅ All models rendered and sliced successfully"
