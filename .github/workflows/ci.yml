name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: true
        fetch-depth: 1

    - name: Configure git for sparse checkout
      run: |
        cd .orca-slicer
        git sparse-checkout set resources/profiles
        cd ..

    - name: Cache APT packages
      uses: awalsh128/cache-apt-pkgs-action@latest
      with:
        packages: openscad xvfb gstreamer1.0-plugins-base libwebkit2gtk-4.1-0
        version: 1.0

    - name: Cache just binary
      id: cache-just
      uses: actions/cache@v4
      with:
        path: /usr/local/bin/just
        key: just-1.36.0-linux-x86_64

    - name: Install just
      if: steps.cache-just.outputs.cache-hit != 'true'
      run: |
        wget -qO- https://github.com/casey/just/releases/download/1.36.0/just-1.36.0-x86_64-unknown-linux-musl.tar.gz | \
        sudo tar xzf - -C /usr/local/bin just

    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        version: "latest"

    - name: Cache uv dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/uv
        key: uv-${{ runner.os }}-${{ hashFiles('uv.lock') }}
        restore-keys: |
          uv-${{ runner.os }}-

    - name: Cache OrcaSlicer
      id: cache-orca
      uses: actions/cache@v4
      with:
        path: /opt/orcaslicer
        key: orcaslicer-2.3.1-ubuntu2404

    - name: Install OrcaSlicer
      if: steps.cache-orca.outputs.cache-hit != 'true'
      run: |
        ORCA_VERSION="2.3.1"
        wget "https://github.com/OrcaSlicer/OrcaSlicer/releases/download/v${ORCA_VERSION}/OrcaSlicer_Linux_AppImage_Ubuntu2404_V${ORCA_VERSION}.AppImage" -O OrcaSlicer.AppImage
        chmod +x OrcaSlicer.AppImage
        ./OrcaSlicer.AppImage --appimage-extract >/dev/null 2>&1
        sudo mv squashfs-root /opt/orcaslicer

    - name: Create OrcaSlicer symlink
      run: sudo ln -sf /opt/orcaslicer/AppRun /usr/local/bin/orca-slicer

    - name: Update justfile for Linux paths
      run: |
        # Replace brew backtick expression (evaluated at parse time, fails on Linux)
        sed -i 's|_openscad_app := .*|_openscad_app := ""|' justfile
        # Update OpenSCAD binary path
        sed -i 's|_openscad_bin := .*|_openscad_bin := "openscad"|' justfile
        # Update OrcaSlicer binary path
        sed -i 's|_orca_slicer_bin := .*|_orca_slicer_bin := "orca-slicer"|' justfile

    - name: Verify tools
      run: |
        just --version
        openscad --version
        xvfb-run orca-slicer --help | head -5

    - name: Sync Python dependencies
      run: uv sync

    - name: Run Customizer linter
      run: uv run python -m scripts.customizer_lint projects/

    - name: Run syntax check
      run: xvfb-run just check

    - name: Render models
      run: |
        mkdir -p artifacts/stl
        find projects -name "*.scad" -type f | while read -r f; do
          project_name=$(dirname "$f" | sed 's|projects/||')
          basename=$(basename "$f" .scad)
          out="artifacts/stl/${project_name}__${basename}.stl"
          echo "Rendering $f -> $out"
          xvfb-run openscad -o "$out" "$f"
        done

    - name: Slice models
      run: |
        find projects -name "*.scad" -type f | while read -r model; do
          project_name=$(dirname "$model" | sed 's|projects/||')
          basename=$(basename "$model" .scad)
          fullname="${project_name}__${basename}"
          echo "Slicing $fullname..."
          xvfb-run just slice "$fullname"
        done

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: build-artifacts
        path: |
          artifacts/stl/*.stl
          artifacts/gcode/*.3mf
          artifacts/logs/*.log
        retention-days: 7

    - name: Check for errors
      run: |
        if grep -r "error when validate" artifacts/logs/ 2>/dev/null; then
          echo "❌ Found validation errors in slicing logs"
          exit 1
        fi
        echo "✅ All models rendered and sliced successfully"
